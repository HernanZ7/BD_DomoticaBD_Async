@model Biblioteca.Casa
@{
    ViewData["Title"] = "Añadir o acceder a una casa";
    var todasLasCasas = ViewBag.TodasLasCasas as IEnumerable<Biblioteca.Casa> ?? Enumerable.Empty<Biblioteca.Casa>();
    var casasDelUsuario = ViewBag.CasasDelUsuario as IEnumerable<Biblioteca.Casa> ?? Enumerable.Empty<Biblioteca.Casa>();
    var casasDisponibles = todasLasCasas.Where(c => !casasDelUsuario.Any(u => u.IdCasa == c.IdCasa));
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Añadir o acceder a una casa</h2>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success text-center">@TempData["Mensaje"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger text-center">@TempData["Error"]</div>
    }
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <ul class="mb-0">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <form asp-action="AltaForm" method="post" class="w-75 mx-auto">
        @Html.AntiForgeryToken()

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5>1. Selecciona qué querés hacer</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Opción:</label>
                    <select id="opcionCasa" name="IdCasaExistente" class="form-select form-select-lg" required>
                        <option value="">-- Elegí una opción --</option>
                        <option value="-1">Crear una casa NUEVA</option>
                        @if (casasDisponibles.Any())
                        {
                            <optgroup label="Acceder a una casa compartida por otro usuario">
                                @foreach (var c in casasDisponibles)
                                {
                                    <option value="@c.IdCasa">@c.Direccion (ID: @c.IdCasa)</option>
                                }
                            </optgroup>
                        }
                        else
                        {
                            <option disabled>No hay casas disponibles para compartir</option>
                        }
                    </select>
                    <div class="form-text">
                        Las casas que ya tenés no aparecen aquí para evitar duplicados.
                    </div>
                </div>
            </div>
        </div>

        <div id="nuevaCasaForm" class="card mb-4" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5>2. Ingresá la dirección de tu nueva casa</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label asp-for="Direccion" class="form-label">Dirección</label>
                    <input asp-for="Direccion" class="form-control" placeholder="Ej: Av. Siempre Viva 742, Springfield" />
                    <span asp-validation-for="Direccion" class="text-danger"></span>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-lg btn-primary">
                Continuar
            </button>
            <a asp-action="GetAll" class="btn btn-lg btn-secondary ms-3">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }

    <script>
        const select = document.getElementById('opcionCasa');
        const nuevaCasaDiv = document.getElementById('nuevaCasaForm');

        select.addEventListener('change', function () {
            if (this.value === '-1') {
                nuevaCasaDiv.style.display = 'block';
                document.querySelector('[name="Direccion"]').setAttribute('required', 'required');
            } else {
                nuevaCasaDiv.style.display = 'none';
                document.querySelector('[name="Direccion"]').removeAttribute('required');
            }
        });

        if (select.value === '-1') {
            nuevaCasaDiv.style.display = 'block';
        }
    </script>
}