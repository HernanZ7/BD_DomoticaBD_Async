@model BD_DomoticaBD_Async.mvc.Models.ElectrodomesticoViewModel
@{
    ViewData["Title"] = "Detalle Electrodoméstico";
    var idCasa = Model?.IdCasa;
}

<div class="container mt-4">
    <h2 class="text-center mb-4">Detalle: @Model.Nombre</h2>

    <div class="card w-75 mx-auto">
        <div class="card-body">
            <h5 class="card-title">@Model.Nombre (@Model.Tipo)</h5>
            
            <p class="card-text"><strong>Ubicación:</strong> @Model.Ubicacion</p>
            <p class="card-text"><strong>Encendido:</strong> @(Model.Encendido ? "Sí" : "No")</p>
            <p class="card-text"><strong>Consumo total (kWh):</strong> @Model.ConsumoTotal</p>

            <p><strong>Inicio:</strong> <span id="inicio">@((Model.Inicio.HasValue) ? Model.Inicio.Value.ToString("yyyy-MM-dd HH:mm:ss") : "N/A")</span></p>
            
            <p><strong>Duración:</strong> 
                <span id="duracion">@((Model.Inicio.HasValue) ? "" : "00:00:00")</span>
            </p>

        </div>
    </div>


    <h4 class="mt-4 text-center">Historial de consumos</h4>
    @if (Model.Consumos == null || !Model.Consumos.Any())
    {
        <div class="alert alert-info text-center">No hay registros de consumo.</div>
    }
    else
    {
        <table class="table table-striped w-75 mx-auto">
            <thead>
                <tr>
                    <th>Fecha Inicio</th>
                    <th>Duración</th>
                    <th>Consumo (kWh)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in Model.Consumos)
                {
                    <tr>
                        <td>@c.Inicio.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@c.Duracion</td>
                        <td>@c.ConsumoTotal</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <div class="text-center mt-4">
        <a asp-action="GetAll" asp-route-idCasa="@idCasa" class="btn btn-secondary">Volver</a>
    </div>
</div>

<script>
(function() {
    // Si Model.Inicio existe, significa que hay un consumo activo (filtrado desde ObtenerConsumoActivoAsync)
    var inicioIso = "@(Model.Inicio.HasValue ? Model.Inicio.Value.ToString("o") : "")";

    if (inicioIso) {
        const start = new Date(inicioIso);

        setInterval(() => {
            const now = new Date();
            const diffMs = now - start;

            if (diffMs < 0) return; // seguridad

            const totalSeconds = Math.floor(diffMs / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
            const s = String(totalSeconds % 60).padStart(2, "0");

            document.getElementById("duracion").textContent = `${h}:${m}:${s}`;
        }, 1000);
    } else {
        // Si no hay inicio, aseguramos que muestre 00:00:00
        document.getElementById("duracion").textContent = "00:00:00";
    }
})();
</script>
